<!DOCTYPE html>
<html lang="fr">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />


    <title>Rezekids : promenade pour enfant Sud Loire</title>

</head>

<body>

    <main class="container py-5">

        <div id="container-row" class="row">
            
        </div>

    </main>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"
        integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous"
        async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script type="text/javascript">

        function initMap(mapContainerId) {

            var target = L.map(mapContainerId).setView([47.17923838969068, -1.5493955763944314], 13);

            L.tileLayer(
                'https://wxs.ign.fr/{apikey}/geoportail/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
                    attribution: '<a target="_blank" href="https://www.geoportail.gouv.fr/">Geoportail France</a>',
                    bounds: [
                        [-75, -180],
                        [81, 180]
                    ],
                    minZoom: 2,
                    maxZoom: 18,
                    apikey: 'cartes',
                    format: 'image/png',
                    style: 'normal'
                }).addTo(target);

            // show the scale bar on the lower left corner
            L.control.scale().addTo(target);

            return target;

        }

        function displayGpx(map, gpx, callback) {

            new L.GPX(gpx, {
                async: true
            }).on('loaded', function (e) {
                map.fitBounds(e.target.getBounds());
                var distance = e.target.get_distance();
                var elevation = e.target.get_elevation_gain();
                callback(distance, elevation);
            }).addTo(map);
        }


        function createCard(item) {

            var container = document.createElement('div');
            container.classList.add('card-container', 'col-sm-6', 'col-lg-4', 'mb-4');
            document.getElementById('container-row').appendChild(container);

            var cardContainer = document.createElement('div');
            cardContainer.classList.add('card', 'shadow');
            container.appendChild(cardContainer);

            var topContainer = document.createElement('div');
            topContainer.classList.add('card-img-top');
            cardContainer.appendChild(topContainer);

            var mapContainer = document.createElement('div');
            mapContainer.setAttribute('id', 'map-' + item.uniqueCode);
            mapContainer.style.height = '250px';
            mapContainer.style.width = '100%';
            topContainer.appendChild(mapContainer);

            var bodyContainer = document.createElement('div');
            bodyContainer.classList.add('card-body');
            topContainer.appendChild(bodyContainer);

            var bodyTitle = document.createElement('h5');
            bodyTitle.classList.add('card-title');
            bodyTitle.textContent = item.title;
            bodyContainer.appendChild(bodyTitle);

            var bodyBadges = document.createElement('p');
            bodyContainer.appendChild(bodyBadges);

            var distanceBadge = document.createElement('span');
            distanceBadge.classList.add('badge', 'bg-light', 'text-dark', 'me-1');
            bodyBadges.appendChild(distanceBadge);

            var elevationBadge = document.createElement('span');
            elevationBadge.classList.add('badge', 'bg-light', 'text-dark', 'me-1');
            bodyBadges.appendChild(elevationBadge);

            var difficultyBadge = document.createElement('span');
            difficultyBadge.classList.add('badge', item.difficulty.class);
            difficultyBadge.textContent = item.difficulty.label;
            bodyBadges.appendChild(difficultyBadge);

            var bodyDescription = document.createElement('p');
            bodyDescription.classList.add('card-text');
            bodyDescription.textContent = item.description;
            bodyContainer.appendChild(bodyDescription);

            var bodyBottomBadges = document.createElement('p');
            bodyContainer.appendChild(bodyBottomBadges);

            var strollerBadge = document.createElement('span');
            strollerBadge.classList.add('badge', item.stroller, 'me-1');
            strollerBadge.textContent = "Poussette";
            bodyBottomBadges.appendChild(strollerBadge);

            var bikeBadge = document.createElement('span');
            bikeBadge.classList.add('badge', item.bike);
            bikeBadge.textContent = "Vélo";
            bodyBottomBadges.appendChild(bikeBadge);

            var gpxUrl = window.location.href + 'gpx/' + item.uniqueCode + '.gpx';
            var cardLink = document.createElement('a');
            cardLink.setAttribute('href', 'https://gpx.tomacla.info?gpx=' + encodeURI(gpxUrl));
            cardLink.classList.add('card-link');
            cardLink.textContent = 'Voir GPX';
            bodyContainer.appendChild(cardLink);

            var cardLinkDl = document.createElement('a');
            cardLinkDl.setAttribute('href', gpxUrl);
            cardLinkDl.classList.add('card-link');
            cardLinkDl.textContent = 'Télécharger GPX';
            bodyContainer.appendChild(cardLinkDl);


            var mapped = initMap('map-' + item.uniqueCode);
            displayGpx(mapped, gpxUrl, function(distance, elevation) {
                distanceBadge.textContent = (distance/1000).toFixed(2) + 'km';
                elevationBadge.textContent = '+' + Math.round(elevation) + 'm';
            });

        }


        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                JSON.parse(this.responseText).forEach(createCard)

                var msnry = new Masonry('#container-row', {
                    itemSelector: '.card-container',
                    percentPosition: true
                });

            }
        };


        xmlhttp.open('GET', './descriptor.json', true);
        xmlhttp.send();
    </script>

</body>


</html>